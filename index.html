<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Finance Salary</title>

<style>
body{font-family:Arial;background:#f2f4f7;margin:20px}
table{width:100%;border-collapse:collapse;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:5px;text-align:center}
th{background:#eee}
input{width:100%;box-sizing:border-box}
button{padding:6px 12px;margin:5px 0;cursor:pointer}
.karyawan{border:2px solid #999;padding:10px;margin-bottom:25px;background:#fafafa}
.green{color:green}
.red{color:red}
.jamnum{width:55px;text-align:center}
</style>
</head>

<body>

<h2>Payroll 2 Minggu â€“ Jam & Istirahat</h2>

Tanggal Mulai:
<input type="date" id="tanggalMulai">

<br><br>
<button id="btnTambah">+ Tambah Karyawan</button>

<h3>Total Jam Bersih: <span id="totJam">0</span></h3>
<h3>Total Gaji: <span class="green" id="totGaji">Rp 0</span></h3>

<hr>

<div id="list"></div>

<script>
document.addEventListener("DOMContentLoaded",function(){

const hari=["Minggu","Senin","Selasa","Rabu","Kamis","Jumat","Sabtu"];
const list=document.getElementById("list");
const btn=document.getElementById("btnTambah");

function ddmmyy(d){
  return String(d.getDate()).padStart(2,"0")+"-"+
         String(d.getMonth()+1).padStart(2,"0")+"-"+
         String(d.getFullYear()).slice(-2);
}

function jamKeMenit(j,m){
  j=Number(j); m=Number(m);
  if(isNaN(j)||isNaN(m)) return null;
  if(j<0||m<0||m>59) return null;
  return j*60+m; // jam boleh >24
}

function buatTabel(){
  let t=`<table>
  <tr>
    <th>Tgl</th><th>Hari</th>
    <th colspan="2">Masuk</th>
    <th colspan="2">Pulang</th>
    <th>Jam Kotor</th>
    <th>Istirahat</th>
    <th>Jam Bersih</th>
  </tr>`;
  for(let i=0;i<14;i++){
    t+=`
    <tr data-i="${i}">
      <td class="tgl"></td>
      <td class="hari"></td>
      <td><input class="jamnum jm"></td>
      <td><input class="jamnum mm"></td>
      <td><input class="jamnum jk"></td>
      <td><input class="jamnum mk"></td>
      <td class="kotor">0</td>
      <td class="rest">0</td>
      <td class="jam">0</td>
    </tr>`;
  }
  return t+"</table>";
}

function refreshTanggal(){
  const start=document.getElementById("tanggalMulai").value;
  if(!start) return;

  document.querySelectorAll("[data-i]").forEach(r=>{
    const d=new Date(start);
    d.setDate(d.getDate()+Number(r.dataset.i));
    r.querySelector(".tgl").innerText=ddmmyy(d);
    r.querySelector(".hari").innerText=hari[d.getDay()];
  });
}

function tambahKaryawan(nama){
  const div=document.createElement("div");
  div.className="karyawan";

  div.innerHTML=`
    Nama:
    <input value="${nama}">
    <button class="hapus">Hapus</button><br><br>

    Gaji / Jam:
    <input type="number" class="gaji" value="20000">

    Tunjangan Makan / Hari:
    <input type="number" class="makan" value="15000">

    Kasbon:
    <input type="number" class="kasbon red" value="0">

    ${buatTabel()}

    <b>Total Jam Bersih:</b> <span class="jTot">0</span><br>
    <b>Gaji Bersih:</b> <span class="gTot green">Rp 0</span>
  `;

  div.querySelector(".hapus").addEventListener("click",()=>{
    div.remove(); hitung();
  });

  list.appendChild(div);
  refreshTanggal();
  hitung();
}

function hitung(){
  let TJ=0, TG=0;

  document.querySelectorAll(".karyawan").forEach(k=>{
    let jamTot=0, makanTot=0;

    const gaji=+k.querySelector(".gaji").value||0;
    const uangMakan=+k.querySelector(".makan").value||0;
    const kasbon=+k.querySelector(".kasbon").value||0;

    k.querySelectorAll("tr[data-i]").forEach(r=>{
      let kotor=0, istirahat=0, bersih=0;

      const jm=r.querySelector(".jm").value;
      const mm=r.querySelector(".mm").value;
      const jk=r.querySelector(".jk").value;
      const mk=r.querySelector(".mk").value;

      const m1=jamKeMenit(jm,mm);
      const m2=jamKeMenit(jk,mk);

      if(m1!==null && m2!==null){
        kotor=(m2-m1)/60;

        // ISTIRAHAT FINAL (FIX)
        if (kotor > 16) istirahat = 3;
        else if (kotor > 9) istirahat = 2;
        else if (kotor > 4) istirahat = 1;

        bersih = kotor - istirahat;
        if(bersih>0) makanTot+=uangMakan;
      }

      r.querySelector(".kotor").innerText=kotor.toFixed(2);
      r.querySelector(".rest").innerText=istirahat;
      r.querySelector(".jam").innerText=bersih.toFixed(2);

      jamTot+=bersih;
    });

    const gajiBersih=(jamTot*gaji)+makanTot-kasbon;

    k.querySelector(".jTot").innerText=jamTot.toFixed(2);
    k.querySelector(".gTot").innerText="Rp "+gajiBersih.toLocaleString();

    TJ+=jamTot;
    TG+=gajiBersih;
  });

  document.getElementById("totJam").innerText=TJ.toFixed(2);
  document.getElementById("totGaji").innerText="Rp "+TG.toLocaleString();
}

btn.addEventListener("click",()=>tambahKaryawan("Karyawan Baru"));
document.body.addEventListener("input",hitung);
document.body.addEventListener("change",()=>{refreshTanggal();hitung();});

document.getElementById("tanggalMulai").value =
  new Date().toISOString().split("T")[0];

for(let i=1;i<=3;i++) tambahKaryawan("Karyawan "+i);

});
</script>

</body>
</html>
