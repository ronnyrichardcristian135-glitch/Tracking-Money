<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tracking Money — Cristian & Maharani</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;font-family:'Poppins',sans-serif;margin:0;padding:0}
    :root{
      --bg:#121212; --card:#1e1e1e; --muted:#9aa3a8; --text:#e6eef2;
      --accent:#00bfa6; --danger:#ff6b6b; --glass:rgba(255,255,255,0.03)
    }
    html,body{height:100%;background:var(--bg);color:var(--text)}
    header{
      background:linear-gradient(180deg,var(--card),#161616);
      padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.03)
    }
    header h1{font-size:1.05rem;color:var(--accent);font-weight:700}
    #resetBtn{background:none;border:0;color:var(--muted);cursor:pointer;font-size:0.95rem;padding:6px 10px;border-radius:8px}
    #resetBtn:hover{color:var(--danger);background:rgba(255,255,255,0.02)}
    nav{display:flex;gap:6px;padding:10px 14px;background:linear-gradient(180deg,var(--card),#171717);border-bottom:1px solid rgba(255,255,255,0.02);position:sticky;top:0;z-index:40}
    nav button{flex:1;background:none;border:0;color:var(--muted);padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    nav button.active{color:var(--accent);background:linear-gradient(90deg,rgba(0,191,166,0.08),transparent);box-shadow:0 6px 18px rgba(0,0,0,0.5)}
    main{padding:18px;max-width:1100px;margin:0 auto}
    .summary{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:16px}
    .card{background:var(--card);padding:12px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
    .card .title{font-size:0.85rem;color:var(--muted);margin-bottom:6px}
    .card .value{font-size:1.1rem;font-weight:700;color:var(--text)}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:14px;align-items:start}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    form{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:8px}
    label{font-size:0.85rem;color:var(--muted)}
    input[type="text"], input[type="date"], select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#232323;color:var(--text);resize:vertical}
    textarea{min-height:70px}
    .btnPrimary{background:var(--accent);border:0;padding:10px;border-radius:8px;color:#001;font-weight:700;cursor:pointer}
    .btnPrimary:hover{background:#00d4bb}
    .history{background:var(--card);padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);max-height:420px;overflow:auto}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px 6px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .meta{color:var(--muted);font-size:0.85rem}
    .actions{display:flex;gap:8px;align-items:center}
    .actions button{background:none;border:0;color:var(--danger);cursor:pointer;padding:6px;border-radius:6px}
    .actions button.pay{color:var(--accent)}
    .small{font-size:0.82rem;color:var(--muted)}
    .tabsSmall{display:flex;gap:6px;margin-top:8px}
    .subTab{background:#242424;padding:8px;border-radius:8px;color:var(--muted);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .subTab.active{color:var(--accent);border-color:rgba(0,191,166,0.12)}
    footer{padding:18px;text-align:center;color:var(--muted);font-size:0.85rem;margin-top:18px}
  </style>
</head>
<body>
  <header>
    <h1>Tracking Money</h1>
    <div>
      <button id="resetBtn" title="Reset Semua Data">⚙️ Reset</button>
    </div>
  </header>

  <nav>
    <button class="active" data-tab="penghasilan">Penghasilan</button>
    <button data-tab="tabungan">Tabungan</button>
    <button data-tab="pengeluaran">Pengeluaran</button>
    <button data-tab="hutang">Hutang Aktif</button>
  </nav>

  <main>
    <!-- Ringkasan -->
    <div class="summary" id="summaryArea">
      <div class="card"><div class="title">Pemasukan Cristian</div><div class="value" id="sumCristian">Rp 0</div></div>
      <div class="card"><div class="title">Pemasukan Maharani</div><div class="value" id="sumMaharani">Rp 0</div></div>
      <div class="card"><div class="title">Tabungan Tetap</div><div class="value" id="sumTetap">Rp 0</div></div>
      <div class="card"><div class="title">Tabungan Bersama</div><div class="value" id="sumBersama">Rp 0</div></div>
      <div class="card"><div class="title">Pengeluaran Bersama</div><div class="value" id="sumPengeluaran">Rp 0</div></div>
    </div>

    <div class="grid">
      <div>
        <!-- PENGHASILAN -->
        <section id="section-penghasilan" class="section active">
          <div class="card" style="margin-bottom:12px">
            <strong>Tambah Penghasilan</strong>
            <form id="formPenghasilan">
              <label>Nama</label>
              <select id="in_nama">
                <option value="Cristian">Cristian</option>
                <option value="Maharani">Maharani</option>
              </select>

              <label>Nominal</label>
              <input id="in_nominal" type="text" inputmode="numeric" placeholder="Contoh: 2.000.000" />

              <label>Keterangan</label>
              <input id="in_ket" type="text" placeholder="Misal: Gaji, Bonus, dll" />

              <button class="btnPrimary" type="submit">Simpan Penghasilan</button>
            </form>
          </div>

          <div class="history card">
            <strong>History Penghasilan</strong>
            <div id="historyPenghasilan" style="margin-top:8px"></div>
          </div>
        </section>

        <!-- TABUNGAN -->
        <section id="section-tabungan" class="section" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <strong>Tambah Tabungan</strong>
            <form id="formTabungan">
              <label>Jenis Tabungan</label>
              <select id="sav_jenis">
                <option value="Tetap">Tetap</option>
                <option value="Bersama">Bersama</option>
              </select>

              <div id="sav_nama_group">
                <label>Nama (untuk Tetap)</label>
                <select id="sav_nama">
                  <option value="Cristian">Cristian</option>
                  <option value="Maharani">Maharani</option>
                </select>
              </div>

              <label>Nominal</label>
              <input id="sav_nominal" type="text" inputmode="numeric" placeholder="Contoh: 1.000.000" />

              <label>Keterangan</label>
              <textarea id="sav_ket" placeholder="Contoh: Tabungan bulan Oktober"></textarea>

              <button class="btnPrimary" type="submit">Simpan Tabungan</button>
            </form>
          </div>

          <div class="history card">
            <strong>History Tabungan</strong>
            <div id="historyTabungan" style="margin-top:8px"></div>
          </div>
        </section>

        <!-- PENGELUARAN -->
        <section id="section-pengeluaran" class="section" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <strong>Tambah Pengeluaran</strong>
            <form id="formPengeluaran">
              <label>Sumber Dana</label>
              <select id="exp_sumber">
                <option value="Cristian">Pemasukan Cristian</option>
                <option value="Maharani">Pemasukan Maharani</option>
                <option value="Bersama">Tabungan Bersama</option>
              </select>

              <label>Nominal</label>
              <input id="exp_nominal" type="text" inputmode="numeric" placeholder="Contoh: 500.000" />

              <label>Keterangan</label>
              <input id="exp_ket" type="text" placeholder="Contoh: Belanja bulanan" />

              <button class="btnPrimary" type="submit">Simpan Pengeluaran</button>
            </form>
          </div>

          <div class="history card">
            <strong>History Pengeluaran</strong>
            <div id="historyPengeluaran" style="margin-top:8px"></div>
          </div>
        </section>

        <!-- HUTANG -->
        <section id="section-hutang" class="section" style="display:none">
          <div class="card" style="margin-bottom:12px">
            <strong>Tambah Hutang Aktif</strong>
            <form id="formHutang">
              <label>Nama</label>
              <select id="debt_nama">
                <option value="Cristian">Cristian</option>
                <option value="Maharani">Maharani</option>
                <option value="Bersama">Bersama</option>
              </select>

              <label>Nominal</label>
              <input id="debt_nominal" type="text" inputmode="numeric" placeholder="Contoh: 1.000.000" />

              <label>Jatuh Tempo</label>
              <input id="debt_tempo" type="date" />

              <button class="btnPrimary" type="submit">Simpan Hutang</button>
            </form>
          </div>

          <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
            <div class="tabsSmall">
              <div class="subTab active" data-sub="activeList">Daftar Hutang</div>
              <div class="subTab" data-sub="payments">History Pembayaran</div>
            </div>
          </div>

          <div class="history card" id="listHutangActive" style="margin-bottom:8px">
            <strong>Hutang Aktif</strong>
            <div id="historyHutang" style="margin-top:8px"></div>
          </div>

          <div class="history card" id="listHutangPayments" style="display:none">
            <strong>History Pembayaran Hutang</strong>
            <div id="historyPayments" style="margin-top:8px"></div>
          </div>
        </section>
      </div>

      <!-- Right column: info & audit -->
      <aside>
        <div class="card" style="margin-bottom:12px">
          <strong>Ringkasan Singkat</strong>
          <div class="small" style="margin-top:8px">
            - Data disimpan di localStorage.<br>
            - Hapus per item otomatis memperbarui ringkasan.<br>
            - Batalkan pembayaran akan mengembalikan kondisi sebelum bayar.
          </div>
        </div>

        <div class="card">
          <strong>Audit / Catatan</strong>
          <div id="auditLog" class="small" style="margin-top:8px;color:var(--muted)"></div>
        </div>
      </aside>
    </div>

    <footer>© Tracking Money — dibuat untuk Cristian & Maharani</footer>
  </main>

  <script>
    // ---------- Utilities ----------
    const LS_KEY = 'tracking_money_v2';
    function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
    function formatRp(n){ return 'Rp ' + Number(n||0).toLocaleString('id-ID'); }
    function parseNum(str){ if(!str) return 0; const d = String(str).replace(/[^\d]/g,''); return d ? parseInt(d,10) : 0; }
    function el(id){ return document.getElementById(id); }
    function now(){ return Date.now(); }

    // ---------- State ----------
    let db = JSON.parse(localStorage.getItem(LS_KEY) || 'null');
    if(!db){
      db = {
        incomes: [],    // {id,name,amount,keterangan,created}
        savings: [],    // {id,jenis,nama,amount,keterangan,created}
        expenses: [],   // {id,source,amount,keterangan,created}
        debts: [],      // {id,name,amount,tempo,created}
        payments: [],   // {id, debtId, amount, source, created}
        audit: []       // strings for audit log (optional)
      };
      localStorage.setItem(LS_KEY, JSON.stringify(db));
    }

    // ---------- Summary computation ----------
    function computeSummary(){
      // base incomes total
      const incomeCristian = db.incomes.filter(i=>i.name==='Cristian').reduce((s,i)=>s+i.amount,0);
      const incomeMaharani = db.incomes.filter(i=>i.name==='Maharani').reduce((s,i)=>s+i.amount,0);

      // tabungan tetap sums (per person)
      const tetapCristian = db.savings.filter(s=>s.jenis==='Tetap' && s.nama==='Cristian').reduce((s,i)=>s+i.amount,0);
      const tetapMaharani = db.savings.filter(s=>s.jenis==='Tetap' && s.nama==='Maharani').reduce((s,i)=>s+i.amount,0);
      const tabunganTetap = tetapCristian + tetapMaharani;

      // tabungan bersama total (sum of all 'Bersama' entries)
      const tabunganBersamaTotal = db.savings.filter(s=>s.jenis==='Bersama').reduce((s,i)=>s+i.amount,0);

      // pengeluaran by source
      const expFromCristian = db.expenses.filter(e=>e.source==='Cristian').reduce((s,i)=>s+i.amount,0);
      const expFromMaharani = db.expenses.filter(e=>e.source==='Maharani').reduce((s,i)=>s+i.amount,0);
      const expFromBersama = db.expenses.filter(e=>e.source==='Bersama').reduce((s,i)=>s+i.amount,0);
      const pengeluaranShared = expFromBersama;

      // payments effects (payments reduce incomes or shared incomes depending on source)
      const payByCristian = db.payments.filter(p=>p.source==='Cristian').reduce((s,p)=>s+p.amount,0);
      const payByMaharani = db.payments.filter(p=>p.source==='Maharani').reduce((s,p)=>s+p.amount,0);
      const payByBersama = db.payments.filter(p=>p.source==='Bersama').reduce((s,p)=>s+p.amount,0);
      // note: payByBersama will be applied as 50% each in resulting incomes

      // resulting incomes after all adjustments:
      // - subtract tabungan tetap per person
      // - subtract half of tabungan bersama from each person's income (tabunganBersamaTotal/2)
      // - subtract expenses from individual sources (expFromCristian/expFromMaharani)
      // - subtract payments made from individual sources (payByCristian/payByMaharani)
      // - subtract half of payments made as 'Bersama' from each person (payByBersama/2)
      const pemasukanCristian = Math.round(
        incomeCristian
        - tetapCristian
        - Math.round(tabunganBersamaTotal/2)
        - expFromCristian
        - payByCristian
        - Math.round(payByBersama/2)
      );

      const pemasukanMaharani = Math.round(
        incomeMaharani
        - tetapMaharani
        - Math.round(tabunganBersamaTotal/2)
        - expFromMaharani
        - payByMaharani
        - Math.round(payByBersama/2)
      );

      const tabunganTetap = tabunganTetap;
      const tabunganBersama = tabunganBersamaTotal - expFromBersama - payByBersama; // tabungan bersama reduced by shared expenses & payments-from-bersama
      // ensure not negative (display purposes)
      return {
        pemasukanCristian: pemasukanCristian,
        pemasukanMaharani: pemasukanMaharani,
        tabunganTetap: tabunganTetap,
        tabunganBersama: tabunganBersama,
        pengeluaranShared: pengeluaranShared
      };
    }

    // ---------- Render ----------
    function renderSummary(){
      const s = computeSummary();
      el('sumCristian').textContent = formatRp(s.pemasukanCristian);
      el('sumMaharani').textContent = formatRp(s.pemasukanMaharani);
      el('sumTetap').textContent = formatRp(s.tabunganTetap);
      el('sumBersama').textContent = formatRp(s.tabunganBersama);
      el('sumPengeluaran').textContent = formatRp(s.pengeluaranShared);
      renderAudit();
    }

    function renderAudit(){
      const node = el('auditLog'); node.innerHTML = '';
      if(!db.audit || db.audit.length===0){ node.textContent = 'Belum ada catatan.'; return; }
      db.audit.slice().reverse().forEach(a=>{
        const div=document.createElement('div'); div.textContent = a; node.appendChild(div);
      });
    }

    function saveDB(){ localStorage.setItem(LS_KEY, JSON.stringify(db)); renderAll(); }

    // render history helpers
    function renderHistories(){
      // incomes
      const incNode = el('historyPenghasilan'); incNode.innerHTML = '';
      if(db.incomes.length===0) incNode.innerHTML = '<div class="small" style="padding:6px;color:var(--muted)">Belum ada data.</div>';
      else db.incomes.slice().reverse().forEach(i=>{
        const row = document.createElement('div'); row.className='item';
        row.innerHTML = `<div>
          <div><strong>${i.name}</strong> — ${formatRp(i.amount)}</div>
          <div class="meta small">${i.keterangan || ''} · ${new Date(i.created).toLocaleString()}</div>
        </div>
        <div class="actions">
          <button title="Hapus" onclick="deleteIncome('${i.id}')">✖</button>
        </div>`;
        incNode.appendChild(row);
      });

      // savings
      const savNode = el('historyTabungan'); savNode.innerHTML = '';
      if(db.savings.length===0) savNode.innerHTML = '<div class="small" style="padding:6px;color:var(--muted)">Belum ada data.</div>';
      else db.savings.slice().reverse().forEach(s=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML = `<div>
          <div><strong>${s.jenis}${s.jenis==='Tetap'?(' • '+s.nama):' • Bersama'}</strong> — ${formatRp(s.amount)}</div>
          <div class="meta small">${s.keterangan || ''} · ${new Date(s.created).toLocaleString()}</div>
        </div>
        <div class="actions">
          <button title="Hapus" onclick="deleteSaving('${s.id}')">✖</button>
        </div>`;
        savNode.appendChild(row);
      });

      // expenses
      const expNode = el('historyPengeluaran'); expNode.innerHTML = '';
      if(db.expenses.length===0) expNode.innerHTML = '<div class="small" style="padding:6px;color:var(--muted)">Belum ada data.</div>';
      else db.expenses.slice().reverse().forEach(e=>{
        const row=document.createElement('div'); row.className='item';
        const label = e.source === 'Bersama' ? 'Tabungan Bersama' : (e.source==='Cristian' ? 'Pemasukan Cristian' : 'Pemasukan Maharani');
        row.innerHTML = `<div>
          <div><strong>${label}</strong> — ${formatRp(e.amount)}</div>
          <div class="meta small">${e.keterangan || ''} · ${new Date(e.created).toLocaleString()}</div>
        </div>
        <div class="actions">
          <button title="Hapus" onclick="deleteExpense('${e.id}')">✖</button>
        </div>`;
        expNode.appendChild(row);
      });

      // debts (active)
      const debtNode = el('historyHutang'); debtNode.innerHTML = '';
      if(db.debts.length===0) debtNode.innerHTML = '<div class="small" style="padding:6px;color:var(--muted)">Belum ada hutang aktif.</div>';
      else db.debts.slice().reverse().forEach(d=>{
        const row=document.createElement('div'); row.className='item';
        row.innerHTML = `<div>
          <div><strong>${d.name}</strong> — ${formatRp(d.amount)}</div>
          <div class="meta small">Tempo: ${d.tempo || '-'} · ${new Date(d.created).toLocaleString()}</div>
        </div>
        <div class="actions">
          <button class="pay" title="Bayar" onclick="openPayDialog('${d.id}')">💸 Bayar</button>
          <button title="Hapus" onclick="deleteDebt('${d.id}')">✖</button>
        </div>`;
        debtNode.appendChild(row);
      });

      // payments (history)
      const payNode = el('historyPayments'); payNode.innerHTML = '';
      if(db.payments.length===0) payNode.innerHTML = '<div class="small" style="padding:6px;color:var(--muted)">Belum ada pembayaran.</div>';
      else db.payments.slice().reverse().forEach(p=>{
        const row=document.createElement('div'); row.className='item';
        const debt = (db.debts.concat([])).find(d=>d.id===p.debtId) || null;
        // Since we remove debt on pay, we will instead store original debt info inside payment if needed.
        const debtInfo = p.debtSnapshot || {};
        row.innerHTML = `<div>
          <div><strong>${debtInfo.name || p.debtName || 'Hutang'}</strong> — ${formatRp(p.amount)} • dari: ${p.source}</div>
          <div class="meta small">${new Date(p.created).toLocaleString()}</div>
        </div>
        <div class="actions">
          <button title="Batalkan Pembayaran" onclick="cancelPayment('${p.id}')">↩️ Batalkan</button>
        </div>`;
        payNode.appendChild(row);
      });

      // save to localStorage
      localStorage.setItem(LS_KEY, JSON.stringify(db));
    }

    function renderAll(){
      renderSummary();
      renderHistories();
    }

    // ---------- CRUD operations ----------
    // Incomes
    el('formPenghasilan').addEventListener('submit', e=>{
      e.preventDefault();
      const name = el('in_nama').value;
      const amount = parseNum(el('in_nominal').value);
      const keterangan = el('in_ket').value.trim();
      if(amount <= 0){ alert('Masukkan nominal valid.'); return; }
      db.incomes.push({ id: uid(), name, amount, keterangan, created: now() });
      db.audit.push(`${new Date().toLocaleString()}: Penghasilan ${name} ditambahkan ${formatRp(amount)}${keterangan?(' — '+keterangan):''}`);
      saveDB();
      el('formPenghasilan').reset();
      clearInputFormats();
    });

    // Savings
    el('sav_jenis').addEventListener('change', ()=> {
      el('sav_nama_group').style.display = el('sav_jenis').value === 'Tetap' ? 'block' : 'none';
    });
    el('sav_nama_group').style.display = el('sav_jenis').value === 'Tetap' ? 'block' : 'none';

    el('formTabungan').addEventListener('submit', e=>{
      e.preventDefault();
      const jenis = el('sav_jenis').value;
      const nama = jenis === 'Tetap' ? el('sav_nama').value : 'Bersama';
      const amount = parseNum(el('sav_nominal').value);
      const ket = el('sav_ket').value.trim();
      if(amount <= 0){ alert('Masukkan nominal valid.'); return; }
      db.savings.push({ id: uid(), jenis, nama, amount, keterangan: ket, created: now() });
      db.audit.push(`${new Date().toLocaleString()}: Tabungan(${jenis}) ${nama} ${formatRp(amount)}${ket?(' — '+ket):''}`);
      saveDB();
      el('formTabungan').reset();
      el('sav_nama_group').style.display = el('sav_jenis').value === 'Tetap' ? 'block' : 'none';
      clearInputFormats();
    });

    // Expenses
    el('formPengeluaran').addEventListener('submit', e=>{
      e.preventDefault();
      const source = el('exp_sumber').value; // Cristian / Maharani / Bersama (tabungan)
      const amount = parseNum(el('exp_nominal').value);
      const ket = el('exp_ket').value.trim();
      if(amount <= 0){ alert('Masukkan nominal valid.'); return; }
      db.expenses.push({ id: uid(), source, amount, keterangan: ket, created: now() });
      db.audit.push(`${new Date().toLocaleString()}: Pengeluaran dari ${source} ${formatRp(amount)}${ket?(' — '+ket):''}`);
      saveDB();
      el('formPengeluaran').reset();
      clearInputFormats();
    });

    // Debts
    el('formHutang').addEventListener('submit', e=>{
      e.preventDefault();
      const name = el('debt_nama').value;
      const amount = parseNum(el('debt_nominal').value);
      const tempo = el('debt_tempo').value;
      if(amount <= 0){ alert('Masukkan nominal valid.'); return; }
      db.debts.push({ id: uid(), name, amount, tempo, created: now() });
      db.audit.push(`${new Date().toLocaleString()}: Hutang ditambahkan — ${name} ${formatRp(amount)} (tempo: ${tempo || '-'})`);
      saveDB();
      el('formHutang').reset();
      clearInputFormats();
    });

    // Delete operations
    window.deleteIncome = function(id){
      if(!confirm('Hapus item penghasilan ini?')) return;
      db.incomes = db.incomes.filter(i=>i.id!==id);
      db.audit.push(`${new Date().toLocaleString()}: Penghasilan dihapus (${id})`);
      saveDB();
    };
    window.deleteSaving = function(id){
      if(!confirm('Hapus item tabungan ini?')) return;
      db.savings = db.savings.filter(s=>s.id!==id);
      db.audit.push(`${new Date().toLocaleString()}: Tabungan dihapus (${id})`);
      saveDB();
    };
    window.deleteExpense = function(id){
      if(!confirm('Hapus item pengeluaran ini?')) return;
      db.expenses = db.expenses.filter(e=>e.id!==id);
      db.audit.push(`${new Date().toLocaleString()}: Pengeluaran dihapus (${id})`);
      saveDB();
    };
    window.deleteDebt = function(id){
      if(!confirm('Hapus hutang ini? (Tidak membayar; hanya menghapus)')) return;
      db.debts = db.debts.filter(d=>d.id!==id);
      db.audit.push(`${new Date().toLocaleString()}: Hutang dihapus (${id})`);
      saveDB();
    };

    // ---------- Payments (Bayar / Batalkan) ----------
    // Open pay dialog (simple prompt-based UI replaced by select popup)
    window.openPayDialog = function(debtId){
      const debt = db.debts.find(d=>d.id===debtId);
      if(!debt) return alert('Hutang tidak ditemukan.');
      // Build a small modal element
      const modal = document.createElement('div');
      modal.style.position='fixed'; modal.style.left='0'; modal.style.top='0'; modal.style.width='100%'; modal.style.height='100%';
      modal.style.display='flex'; modal.style.alignItems='center'; modal.style.justifyContent='center'; modal.style.zIndex='9999';
      modal.innerHTML = `
        <div style="background:var(--card);padding:18px;border-radius:12px;min-width:320px;max-width:90%;box-shadow:0 10px 40px rgba(0,0,0,0.6);">
          <div style="margin-bottom:8px;font-weight:700">Bayar Hutang</div>
          <div style="margin-bottom:8px">${debt.name} — ${formatRp(debt.amount)}</div>
          <label style="display:block;margin-bottom:6px;color:var(--muted)">Pilih Sumber Dana</label>
          <select id="paySourceSelect" style="width:100%;padding:10px;border-radius:8px;background:#232323;color:var(--text);border:1px solid rgba(255,255,255,0.03)">
            <option value="Cristian">Cristian</option>
            <option value="Maharani">Maharani</option>
            <option value="Bersama">Bersama</option>
          </select>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px">
            <button id="payCancelBtn" style="background:none;border:0;color:var(--muted);padding:8px;border-radius:8px;cursor:pointer">Batal</button>
            <button id="payConfirmBtn" style="background:var(--accent);border:0;padding:8px 12px;border-radius:8px;color:#001;cursor:pointer">Konfirmasi Bayar</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);

      el('payCancelBtn').addEventListener('click', ()=>{ modal.remove(); });
      el('payConfirmBtn').addEventListener('click', ()=>{
        const src = el('paySourceSelect').value;
        // apply payment logic:
        applyPayment(debtId, src);
        modal.remove();
      });
    };

    function applyPayment(debtId, source){
      const debt = db.debts.find(d=>d.id===debtId);
      if(!debt) return alert('Hutang tidak ditemukan.');
      // Create payment record with snapshot of debt for undo clarity
      const payment = {
        id: uid(),
        debtId: debt.id,
        debtSnapshot: { id: debt.id, name: debt.name, amount: debt.amount, tempo: debt.tempo },
        debtName: debt.name,
        amount: debt.amount,
        source: source,
        created: now()
      };
      // Remove debt from active list
      db.debts = db.debts.filter(d=>d.id!==debtId);
      // Add payment record
      db.payments.push(payment);
      db.audit.push(`${new Date().toLocaleString()}: Hutang ${payment.debtSnapshot.name} ${formatRp(payment.amount)} dibayar dari ${source}`);
      saveDB();
    }

    // Cancel payment -> restore debt and remove payment, and audit
    window.cancelPayment = function(paymentId){
      if(!confirm('Batalkan pembayaran ini? Sistem akan mengembalikan hutang aktif dan memulihkan perhitungan.')) return;
      const p = db.payments.find(x=>x.id===paymentId);
      if(!p) return alert('Pembayaran tidak ditemukan.');
      // Restore debt (use snapshot)
      const snap = p.debtSnapshot || { id: uid(), name: p.debtName || 'Hutang', amount: p.amount, tempo: '' };
      db.debts.push({
        id: snap.id || uid(),
        name: snap.name,
        amount: snap.amount,
        tempo: snap.tempo || '',
        created: snap.created || now()
      });
      // Remove payment entry
      db.payments = db.payments.filter(x=>x.id!==paymentId);
      db.audit.push(`${new Date().toLocaleString()}: Pembayaran dibatalkan untuk hutang ${snap.name} ${formatRp(snap.amount)}`);
      saveDB();
    };

    // ---------- Reset ----------
    el('resetBtn').addEventListener('click', ()=>{
      if(!confirm('Yakin reset semua data? Tindakan ini tidak dapat dibatalkan.')) return;
      localStorage.removeItem(LS_KEY);
      location.reload();
    });

    // ---------- Delete helpers for external calls (if needed) ----------
    window.deleteIncome = function(id){ if(!confirm('Hapus item penghasilan ini?')) return; db.incomes = db.incomes.filter(i=>i.id!==id); db.audit.push(`${new Date().toLocaleString()}: Penghasilan dihapus`); saveDB(); }
    window.deleteSaving = function(id){ if(!confirm('Hapus item tabungan ini?')) return; db.savings = db.savings.filter(s=>s.id!==id); db.audit.push(`${new Date().toLocaleString()}: Tabungan dihapus`); saveDB(); }
    window.deleteExpense = function(id){ if(!confirm('Hapus item pengeluaran ini?')) return; db.expenses = db.expenses.filter(e=>e.id!==id); db.audit.push(`${new Date().toLocaleString()}: Pengeluaran dihapus`); saveDB(); }
    window.deleteDebt = function(id){ if(!confirm('Hapus hutang ini?')) return; db.debts = db.debts.filter(d=>d.id!==id); db.audit.push(`${new Date().toLocaleString()}: Hutang dihapus`); saveDB(); }

    // ---------- Input formatting: Rp while typing ----------
    function attachCurrency(id){
      const input = el(id);
      input.addEventListener('input', ()=>{
        const raw = input.value.replace(/[^\d]/g,'');
        input.value = raw ? 'Rp ' + Number(raw).toLocaleString('id-ID') : '';
        // caret to end
        input.setSelectionRange(input.value.length, input.value.length);
      });
    }
    ['in_nominal','sav_nominal','exp_nominal','debt_nominal'].forEach(id=>{
      if(el(id)) attachCurrency(id);
    });

    function clearInputFormats(){
      ['in_nominal','sav_nominal','exp_nominal','debt_nominal'].forEach(id=>{ if(el(id)) el(id).value=''; });
    }

    // ---------- Tabs ----------
    document.querySelectorAll('nav button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const target = btn.dataset.tab || btn.getAttribute('data-tab') || btn.getAttribute('data-target') || btn.dataset.target;
        // hide all sections
        document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'), s=>s.style.display='none');
        // show appropriate
        if(btn.textContent.includes('Penghasilan') || target==='penghasilan') showSection('section-penghasilan');
        if(btn.textContent.includes('Tabungan') || target==='tabungan') showSection('section-tabungan');
        if(btn.textContent.includes('Pengeluaran') || target==='pengeluaran') showSection('section-pengeluaran');
        if(btn.textContent.includes('Hutang') || target==='hutang') showSection('section-hutang');
        window.scrollTo({top:0,behavior:'smooth'});
      });
    });

    function showSection(id){
      document.querySelectorAll('.section').forEach(s=>{ s.style.display='none'; s.classList.remove('active');});
      const sec = el(id);
      if(sec){ sec.style.display='block'; sec.classList.add('active'); }
    }

    // Subtabs within Hutang (Daftar / Payments)
    document.querySelectorAll('.subTab').forEach(st=>{
      st.addEventListener('click', ()=>{
        document.querySelectorAll('.subTab').forEach(x=>x.classList.remove('active'));
        st.classList.add('active');
        const sub = st.dataset.sub;
        if(sub==='activeList'){ el('listHutangActive').style.display='block'; el('listHutangPayments').style.display='none'; }
        else { el('listHutangActive').style.display='none'; el('listHutangPayments').style.display='block'; }
      });
    });

    // ---------- Initial render ----------
    function renderAll(){ renderSummary(); renderHistories(); }
    renderAll();

    // Expose db for debugging
    window._trackingDB = db;
  </script>
</body>
</html>
